<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="Scripts/jquery-1.6.4.min.js" type="text/javascript"></script>
    <script src="Scripts/jquery.signalR.min.js" type="text/javascript"></script>
    <script src="Scripts/knockout-2.0.0.js" type="text/javascript"></script>
    <script src="Scripts/underscore.js" type="text/javascript"></script>
    <script src="signalr/hubs" type="text/javascript"></script>
    <script type="text/javascript">

        //knockout

        function keyValuePair(key, value) {
            var self = this;

            self.key = key;
            self.value = value;
        }

        function errorViewModel(envelope) {
            var self = this;

            var time = new Date(parseFloat(envelope.error.time.slice(6, 19))).toLocaleString();
            var e = envelope.error;

            self.id = envelope.id;
            self.message = e.message;
            self.time = time;
            self.host = e.host;
            self.type = e.type;
            self.source = e.source;
            self.detail = e.detail;
            self.user = e.user;
            self.statusCode = e.statusCode;
            self.webHostHtmlMessage = e.webHostHtmlMessage;
            self.url = e.url;

            self.serverVariables = ko.observableArray([]);
            self.form = ko.observableArray([]);
            self.cookies = ko.observableArray([]);

            for (var sv in e.serverVariables) {
                self.serverVariables.push(new keyValuePair(sv, e.serverVariables[sv]));
            };
            for (var f in e.form) {
                self.form.push(new keyValuePair(f, e.form[f]));
            };
            for (var c in e.cookies) {
                self.cookies.push(new keyValuePair(c, e.cookies[c]));
            };
        }

        function applicationViewModel(applicationName, infoUrl, doStats) {
            var self = this;

            self.applicationName = applicationName;
            self.infoUrl = infoUrl;
            self.errors = ko.observableArray([]);

            self.doStats = doStats;

            self.addError = function (envelope) {

                self.errors.push(new errorViewModel(envelope));
                self.errors.sort(function (l, r) {
                    //descending by time
                    return l.time > r.time ? -1 : (l.time == r.time ? 0 : 1);
                });

                doStats(self.errors());
            };

            this.fadeIn = function (elem) { if (elem.nodeType === 1) $(elem).hide().slideDown(1200); };
        }

        function errorsViewModel() {
            var self = this;

            self.applications = ko.observableArray([]);
            self.stats = ko.observableArray([]);

            self.doStats = function (data) {
            };

            self.addApplication = function (applicationName, infoUrl) {
                var found = false;
                var apps = self.applications();
                for (a in apps) {
                    var appName = apps[a].applicationName;
                    if (appName == applicationName) {
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    self.applications.push(new applicationViewModel(applicationName, infoUrl, self.doStats));
                }
            };
        }

        var model = new errorsViewModel();

        $(function () {

            var elmahr = $.connection.elmahr;

            $.connection.hub.start(function () {
                elmahr.connect();
            });

            elmahr.notifyError = function (envelope) {
                var infoUrl = envelope.infoUrl;

                model.addApplication(envelope.applicationName, infoUrl);

                var apps = model.applications();
                for (a in apps) {
                    var appName = apps[a].applicationName;
                    if (appName == envelope.applicationName) {
                        model.applications()[a].addError(envelope);
                    }
                }
            };

            // Activates knockout.js
            ko.applyBindings(model);
        });

    </script>
    <style type="text/css">
        body
        {
            background-color: white;
        }
        body, td, th, input, select
        {
            font-family: Arial, Sans-Serif;
            font-size: small;
        }
        li
        {
            margin-bottom: 0.5em;
        }
        h1
        {
            font-size: large;
        }
        h2
        {
            font-size: medium;
        }
        h3
        {
            font-size: small;
        }
    </style>
    <script type="text/javascript">

        model.doStats = function (errors) {

            //errors count
            var total = _.chain(errors)
                .reduce(function (acc, e) { return acc + 1; }, 0)
                .value();
            $('#total').text(total);

            //error types count
            var types = _.chain(errors)
                .groupBy(function (e) { return e.type; })
                .reduce(function (acc, e) { return acc + 1; }, 0)
                .value();
            $('#types').text(types);

            //types stats
            model.stats.removeAll();
            _.chain(errors)
                .groupBy(function (q) { return q.type; })
                .map(function (val, key) { return new keyValuePair(key, val.length); })
                .sortBy(function (kvp) {
                    return kvp.key;
                })
                .each(function (kvp) {
                    model.stats.push(kvp);
                });
        };
        
    </script>
</head>
<body>
    <h1>
        SignalR-ed Unhandled exceptions</h1>
    <h2>
        Stats</h2>
    <p>
        Total errors: <span id="total"></span>
    </p>
    <p>
        Error types: <span id="types"></span>
    </p>
    <ul data-bind="foreach: stats">
        <li><span data-bind="text: key"></span>: <span data-bind="text: value"></span></li>
    </ul>
    <h2>
        Errors</h2>
    <ul data-bind="foreach: applications">
        <li>
            <h2 data-bind="text: applicationName">
            </h2>
            <p>
                Info: <a target="_blank" data-bind="attr: { href: infoUrl, title: 'Info' }, 
                                            text: infoUrl">Info</a></p>
            <ul data-bind="template: { foreach: errors, afterAdd: fadeIn }">
                <li>
                    <p>
                        [<span data-bind="text: time"></span>] Error on <span data-bind="text: host"></span>
                        of type <span data-bind="text: type"></span>: <strong data-bind="text: message">
                        </strong>
                    </p>
                    <a data-bind="attr: { href: url, title: message }" target="_blank">Yellow screen of
                        death</a>
                    <h3>
                        Form</h3>
                    <ul data-bind="foreach: form">
                        <li><span data-bind="text: key"></span>: <span data-bind="text: value"></span></li>
                    </ul>
                </li>
            </ul>
        </li>
    </ul>
</body>
</html>
