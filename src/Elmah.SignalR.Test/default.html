<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="Scripts/jquery-1.6.4.min.js" type="text/javascript"></script>
    <script src="Scripts/jquery.signalR.min.js" type="text/javascript"></script>
    <script src="Scripts/knockout-2.0.0.js" type="text/javascript"></script>
    <script src="signalr/hubs" type="text/javascript"></script>
</head>
<body>
    <div>
        <script type="text/javascript">

            //knockout

            function errorDescriptor(id, description, time, host, type) {
                var self = this;
                
                self.id = id;
                self.description = description;
                self.time = time;
                self.host = host;
                self.type = type;
            }
            
            function applicationDescriptor(applicationName) {
                var self = this;

                self.applicationName = applicationName;
                self.errors = ko.observableArray([]);

                self.addError = function (id, description, time, host, type) {
                    self.errors.push(new errorDescriptor(id, description, time, host, type));
                };
            }

            function errorsViewModel() {
                var self = this;

                self.applications = ko.observableArray([]);

                self.addApplication = function (applicationName) {
                    var found = false;
                    var apps = self.applications();
                    for (a in apps) {
                        var appName = apps[a].applicationName;
                        if (appName == applicationName) {
                            found = true;
                            break;
                        }
                    }
                    if (!found)
                        self.applications.push(new applicationDescriptor(applicationName));
                };
            }

            var model = new errorsViewModel();

            $(function () {

                var elmahr = $.connection.elmahr;

                $.connection.hub.start(function () {
                    elmahr.connect();
                });

                elmahr.notifyError = function (envelope) {
                    var d = new Date(parseFloat(envelope.error.time.slice(6, 19))).toLocaleString();
                    var e = envelope.error;
                    var id = envelope.id;

                    model.addApplication(envelope.applicationName);

                    var apps = model.applications();
                    for (a in apps) {
                        var appName = apps[a].applicationName;
                        if (appName == envelope.applicationName) {
                            model.applications()[a].addError(id, e.message, d, e.host, e.type);
                        }
                    }
                };

                // Activates knockout.js
                ko.applyBindings(model);
            });

        </script>
        <h2>
            SignalR-ed Unhandled exceptions</h2>
            
        <ul data-bind="foreach: applications">
            <li>
                <p data-bind="text: applicationName"></p>
                <ol data-bind="foreach: errors">
                    <li>
                        [<span data-bind="text: time"></span>] Error on <span data-bind="text: host"></span> 
                        of type <span data-bind="text: type"></span>: <strong data-bind="text: description"></strong>
                    </li>
                </ol>
            </li>
        </ul>

    </div>
</body>
</html>
