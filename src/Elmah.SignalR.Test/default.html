<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="Scripts/jquery-1.6.4.min.js" type="text/javascript"></script>
    <script src="Scripts/jquery.signalR.min.js" type="text/javascript"></script>
    <script src="Scripts/knockout-2.0.0.js" type="text/javascript"></script>
    <script src="signalr/hubs" type="text/javascript"></script>
</head>
<body>
    <div>
        <script type="text/javascript">

            //knockout

            function keyValuePair(key, value) {
                var self = this;

                self.key = key;
                self.value = value;
            }

            function errorDescriptor(id,
                        message,
                        time,
                        host,
                        type,
                        source,
                        detail,
                        user,
                        statusCode,
                        webHostHtmlMessage,
                        serverVariables,
                        form,
                        cookies,
                        url) {
                var self = this;

                self.id = id;
                self.message = message;
                self.time = time;
                self.host = host;
                self.type = type;
                self.source = source;
                self.detail = detail;
                self.user = user;
                self.statusCode = statusCode;
                self.webHostHtmlMessage = webHostHtmlMessage;
                self.url = url;

                self.serverVariables = ko.observableArray([]);
                self.form = ko.observableArray([]);
                self.cookies = ko.observableArray([]);

                for (var sv in serverVariables) {
                    self.serverVariables.push(new keyValuePair(sv, serverVariables[sv]));
                };
                for (var f in form) {
                    self.form.push(new keyValuePair(f, form[f]));
                };
                for (var c in cookies) {
                    self.cookies.push(new keyValuePair(c, cookies[c]));
                };

            }

            function applicationDescriptor(applicationName) {
                var self = this;

                self.applicationName = applicationName;
                self.errors = ko.observableArray([]);

                self.addError = function (id,
                        message,
                        time,
                        host,
                        type,
                        source,
                        detail,
                        user,
                        statusCode,
                        webHostHtmlMessage,
                        serverVariables,
                        form,
                        cookies,
                        url) {
                    self.errors.push(new errorDescriptor(id,
                        message,
                        time,
                        host,
                        type,
                        source,
                        detail,
                        user,
                        statusCode,
                        webHostHtmlMessage,
                        serverVariables,
                        form,
                        cookies,
                        url));
                };
            }

            function errorsViewModel() {
                var self = this;

                self.applications = ko.observableArray([]);

                self.addApplication = function (applicationName) {
                    var found = false;
                    var apps = self.applications();
                    for (a in apps) {
                        var appName = apps[a].applicationName;
                        if (appName == applicationName) {
                            found = true;
                            break;
                        }
                    }
                    if (!found)
                        self.applications.push(new applicationDescriptor(applicationName));
                };
            }

            var model = new errorsViewModel();

            $(function () {

                var elmahr = $.connection.elmahr;

                $.connection.hub.start(function () {
                    elmahr.connect();
                });

                elmahr.notifyError = function (envelope) {
                    var d = new Date(parseFloat(envelope.error.time.slice(6, 19))).toLocaleString();
                    var e = envelope.error;
                    var id = envelope.id;

                    model.addApplication(envelope.applicationName);

                    var apps = model.applications();
                    for (a in apps) {
                        var appName = apps[a].applicationName;
                        if (appName == envelope.applicationName) {
                            model.applications()[a].addError(id,
                                e.message,
                                d,
                                e.host,
                                e.type,
                                e.source,
                                e.detail,
                                e.user,
                                e.statusCode,
                                e.webHostHtmlMessage,
                                e.serverVariables,
                                e.form,
                                e.cookies,
                                e.url);
                        }
                    }
                };

                // Activates knockout.js
                ko.applyBindings(model);
            });

        </script>
        <h2>
            SignalR-ed Unhandled exceptions</h2>
        <ul data-bind="foreach: applications">
            <li>
                <p data-bind="text: applicationName">
                </p>
                <ol data-bind="foreach: errors">
                    <li>
                        <p>
                            [<span data-bind="text: time"></span>] Error on <span data-bind="text: host"></span>
                            of type <span data-bind="text: type"></span>: <strong data-bind="text: message">
                            </strong>
                        </p>
                        <a data-bind="attr: { href: url, title: message }">Yellow screen of death</a>
                        <h4>
                            Form</h4>
                        <ul data-bind="foreach: form">
                            <li><span data-bind="text: key"></span>: <span data-bind="text: value"></span></li>
                        </ul>
                    </li>
                </ol>
            </li>
        </ul>
    </div>
</body>
</html>
